<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Contrat — Orvanta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Contrat de service Orvanta" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="styles.css" />

  <link rel="apple-touch-icon" sizes="180x180" href="../favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon_io/favicon-16x16.png">
  <link rel="manifest" href="../favicon_io/site.webmanifest">
</head>

<body>

  <!-- Header (Hidden on Print) -->
  <header class="no-print">
    <nav class="nav">
      <div class="brand">Orvanta</div>
      <div class="nav-links">
        <a href="../index.html">Accueil</a>
      </div>
    </nav>
  </header>

  <div class="contract-container">
    <!-- Logo and Header Row -->
    <div class="contract-top">
      <div class="contract-logo">
        <img src="../logo.png" alt="Orvanta Logo" />
      </div>

      <div class="contract-header">
        <h1>Entente de Service</h1>
        <p class="client-name">Client : <span id="clientName">Chargement...</span></p>
        <p class="contract-date">Date : <span id="currentDate">Chargement...</span></p>
        <p class="contract-status">Statut : <span id="contractStatus" class="status-badge">Chargement...</span></p>
      </div>
    </div>

    <!-- Contract Body -->
    <div class="contract-body">
      <section class="contract-section">
        <h2>Bienvenue chez Orvanta</h2>
        <p>
          Nous sommes heureux de vous accueillir en tant que client d'Orvanta, votre partenaire de confiance
          en matière de recouvrement d'actifs. Notre équipe se consacre à la localisation, la vérification
          et la récupération d'actifs perdus, retenus ou non réclamés avec professionnalisme et discrétion.
        </p>
      </section>

      <section class="contract-section">
        <h2>Objet de l'Entente</h2>
        <p>
          La présente entente définit les termes et conditions selon lesquels Orvanta s'engage à fournir
          des services de recouvrement d'actifs au client. Nos services comprennent l'identification,
          la recherche, la documentation et le recouvrement d'actifs financiers qui vous appartiennent
          légitimement.
        </p>
      </section>

      <section class="contract-section">
        <h2>Nos Engagements</h2>
        <ul>
          <li><strong>Transparence totale</strong> : Nous vous informons à chaque étape du processus</li>
          <li><strong>Confidentialité</strong> : Vos informations personnelles sont protégées avec les plus hauts standards de sécurité</li>
          <li><strong>Professionnalisme</strong> : Notre équipe qualifiée gère votre dossier avec expertise</li>
          <li><strong>Paiement au succès</strong> : Nos honoraires sont dus uniquement après le recouvrement réussi de vos actifs</li>
        </ul>
      </section>

      <section class="contract-section">
        <h2>Modalités de Service</h2>
        <p>
          Orvanta s'engage à agir dans votre meilleur intérêt et conformément aux lois et règlements
          applicables. Nous maintenons une communication régulière et vous fournissons tous les documents
          nécessaires pour assurer la transparence de nos démarches.
        </p>
      </section>

      <section class="contract-section">
        <h2>Coordonnées</h2>
        <p>
          Pour toute question ou préoccupation concernant votre dossier, n'hésitez pas à nous contacter :
        </p>
        <p class="contact-info">
          <strong>Courriel :</strong> support@orvanta.ca<br>
          <strong>Site Web :</strong> www.orvanta.ca
        </p>
      </section>

      <!-- Financial Summary Section -->
      <section class="contract-section financial-section" id="financialSection" style="display: none;">
        <h2>Résumé Financier</h2>
        <div class="financial-table">
          <div class="financial-row">
            <span class="financial-label">Valeur totale des actifs :</span>
            <span class="financial-value" id="totalAssets">0.00 $</span>
          </div>
          <div class="financial-row">
            <span class="financial-label">Frais de service Orvanta (10% ou 100 $, selon le plus élevé) :</span>
            <span class="financial-value fee" id="feeAmount">0.00 $</span>
          </div>
          <div class="financial-row total">
            <span class="financial-label">Montant net à recevoir :</span>
            <span class="financial-value total" id="netAmount">0.00 $</span>
          </div>
        </div>
      </section>

      <section class="contract-section signature-section">
        <p class="closing-statement">
          Nous vous remercions de votre confiance et nous réjouissons de travailler avec vous pour
          récupérer ce qui vous appartient légitimement.
        </p>

        <!-- Client Signature -->
        <div class="signature-display-block">
          <h3>Signature du Client</h3>
          <div id="signatureDisplay" class="signature-display">
            <p class="loading-text">Chargement de la signature...</p>
          </div>
        </div>

        <div class="signature-block">
          <p class="signature-line">
            Cordialement,<br>
            <strong>L'équipe Orvanta</strong>
          </p>
        </div>
      </section>
    </div>

    <!-- Print Button (Hidden on Print) -->
    <div class="print-button-container no-print">
      <button onclick="window.print()" class="print-button">Imprimer / Exporter PDF</button>
    </div>
  </div>

  <script>
    // Get UUID from URL parameter
    function getUuidFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('uuid');
    }

    // Fetch contract data from endpoint
    async function loadContractData() {
      const uuid = getUuidFromUrl();

      // If no UUID, redirect to home
      if (!uuid) {
        window.location.href = '../index.html';
        return;
      }

      try {
        const response = await fetch(`https://n8n.orvanta.ca/webhook/contrat?uuid=${uuid}`);
        const data = await response.json();

        // Assuming the endpoint returns an array, get the first item
        const contractData = Array.isArray(data) ? data[0] : data;

        // Set the client name
        if (contractData.prenom && contractData.nom) {
          const clientNameElement = document.getElementById('clientName');
          clientNameElement.textContent = `${contractData.prenom} ${contractData.nom}`;
        }

        // Set the date from the API
        if (contractData.received_at) {
          const dateElement = document.getElementById('currentDate');
          const date = new Date(contractData.received_at);
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          dateElement.textContent = date.toLocaleDateString('fr-CA', options);
        }

        // Set the status
        if (contractData.status) {
          const statusElement = document.getElementById('contractStatus');
          const statusText = getStatusText(contractData.status);
          statusElement.textContent = statusText;
          statusElement.className = 'status-badge status-' + contractData.status;
        }

        // Display the signature
        if (contractData.signature_base64) {
          const signatureDisplay = document.getElementById('signatureDisplay');
          const img = document.createElement('img');
          img.src = 'data:image/png;base64,' + contractData.signature_base64;
          img.alt = 'Signature du client';
          img.className = 'signature-image';
          signatureDisplay.innerHTML = '';
          signatureDisplay.appendChild(img);
        }

        // Calculate and display financial summary
        if (contractData.valeur && Array.isArray(contractData.valeur)) {
          const totalAssets = contractData.valeur.reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
          const fee = Math.max(totalAssets * 0.10, 100);
          const netAmount = totalAssets - fee;

          // Update the financial section
          document.getElementById('totalAssets').textContent = totalAssets.toFixed(2) + ' $';
          document.getElementById('feeAmount').textContent = fee.toFixed(2) + ' $';
          document.getElementById('netAmount').textContent = netAmount.toFixed(2) + ' $';

          // Show the financial section
          document.getElementById('financialSection').style.display = 'block';
        }

      } catch (error) {
        console.error('Erreur lors du chargement des données du contrat:', error);

        // Fallback to current date if API fails
        const dateElement = document.getElementById('currentDate');
        const today = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = today.toLocaleDateString('fr-CA', options);

        document.getElementById('clientName').textContent = 'Non disponible';
        document.getElementById('contractStatus').textContent = 'Non disponible';
        document.getElementById('signatureDisplay').innerHTML = '<p class="error-text">Signature non disponible</p>';
      }
    }

    // Convert status to French
    function getStatusText(status) {
      const statusMap = {
        'new': 'En processus',
        'pending': 'En attente',
        'approved': 'Approuvé',
        'completed': 'Complété',
        'cancelled': 'Annulé'
      };
      return statusMap[status] || status;
    }

    // Load data when page loads
    loadContractData();
  </script>

</body>
</html>
